// Prisma Schema for Cartify E-Commerce Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  phone         String?
  role          UserRole @default(CUSTOMER)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens       RefreshToken[]
  addresses           Address[]
  cart                Cart?
  wishlistItems       Wishlist[]
  orders              Order[]
  reviews             Review[]
  notifications       Notification[]
  notificationPrefs   NotificationPreference?
  loyaltyPoints       LoyaltyPoints?
  loyaltyTransactions LoyaltyTransaction[]
  returns             Return[]
  supportTickets      SupportTicket[]
  supportMessages     SupportMessage[]

  @@map("users")
}

enum UserRole {
  ADMIN
  CUSTOMER
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================================================
// PRODUCTS & CATEGORIES
// ============================================================================

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  imageUrl    String?   @map("image_url")
  parentId    String?   @map("parent_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  description  String
  price        Decimal
  comparePrice Decimal? @map("compare_price")
  stockQty     Int      @default(0) @map("stock_quantity")
  sku          String   @unique
  brand        String?
  categoryId   String   @map("category_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  category   Category           @relation(fields: [categoryId], references: [id])
  images     ProductImage[]
  variants   ProductVariant[]
  attributes ProductAttribute[]
  cartItems  CartItem[]
  wishlist   Wishlist[]
  reviews    Review[]
  orderItems OrderItem[]

  @@map("products")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  url       String
  altText   String?  @map("alt_text")
  position  Int      @default(0)
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id         String  @id @default(uuid())
  productId  String  @map("product_id")
  name       String
  sku        String  @unique
  price      Decimal
  stockQty   Int     @default(0) @map("stock_quantity")
  attributes Json?

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("product_variants")
}

model ProductAttribute {
  id             String @id @default(uuid())
  productId      String @map("product_id")
  attributeName  String @map("attribute_name")
  attributeValue String @map("attribute_value")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_attributes")
}

// ============================================================================
// SHOPPING & CART
// ============================================================================

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id         String   @id @default(uuid())
  cartId     String   @map("cart_id")
  productId  String   @map("product_id")
  variantId  String?  @map("variant_id")
  quantity   Int      @default(1)
  priceAtAdd Decimal  @map("price_at_add")
  createdAt  DateTime @default(now()) @map("created_at")

  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("cart_items")
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlists")
}

model Address {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  type       AddressType
  fullName   String      @map("full_name")
  phone      String
  street     String
  city       String
  state      String
  postalCode String      @map("postal_code")
  country    String
  isDefault  Boolean     @default(false) @map("is_default")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordersAsShipping    Order[] @relation("ShippingAddress")
  ordersAsBilling     Order[] @relation("BillingAddress")

  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

// ============================================================================
// ORDERS
// ============================================================================

model Order {
  id                 String        @id @default(uuid())
  userId             String        @map("user_id")
  orderNumber        String        @unique @map("order_number")
  status             OrderStatus   @default(PENDING)
  subtotal           Decimal
  tax                Decimal
  shippingCost       Decimal       @map("shipping_cost")
  total              Decimal
  paymentStatus      PaymentStatus @default(PENDING) @map("payment_status")
  shippingAddressId  String        @map("shipping_address_id")
  billingAddressId   String        @map("billing_address_id")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  user            User            @relation(fields: [userId], references: [id])
  shippingAddress Address         @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address         @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items           OrderItem[]
  tracking        OrderTracking[]
  returns         Return[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  quantity  Int
  price     Decimal
  subtotal  Decimal
  createdAt DateTime @default(now()) @map("created_at")

  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product         @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  returnItems ReturnItem[]

  @@map("order_items")
}

model OrderTracking {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  status    String
  location  String?
  notes     String?
  timestamp DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_tracking")
}

// ============================================================================
// REVIEWS & RATINGS
// ============================================================================

model Review {
  id               String       @id @default(uuid())
  productId        String       @map("product_id")
  userId           String       @map("user_id")
  rating           Int
  title            String
  comment          String
  verifiedPurchase Boolean      @default(false) @map("verified_purchase")
  helpfulCount     Int          @default(0) @map("helpful_count")
  unhelpfulCount   Int          @default(0) @map("unhelpful_count")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  images  ReviewImage[]
  votes   ReviewVote[]

  @@map("reviews")
}

model ReviewImage {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  url       String
  createdAt DateTime @default(now()) @map("created_at")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_images")
}

model ReviewVote {
  id       String   @id @default(uuid())
  reviewId String   @map("review_id")
  userId   String   @map("user_id")
  voteType VoteType @map("vote_type")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@map("review_votes")
}

enum VoteType {
  HELPFUL
  UNHELPFUL
}

// ============================================================================
// RETURNS & REFUNDS
// ============================================================================

model Return {
  id           String       @id @default(uuid())
  orderId      String       @map("order_id")
  userId       String       @map("user_id")
  reason       String
  status       ReturnStatus @default(PENDING)
  refundAmount Decimal      @map("refund_amount")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  order Order        @relation(fields: [orderId], references: [id])
  user  User         @relation(fields: [userId], references: [id])
  items ReturnItem[]

  @@map("returns")
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model ReturnItem {
  id          String @id @default(uuid())
  returnId    String @map("return_id")
  orderItemId String @map("order_item_id")
  quantity    Int
  condition   String

  return    Return    @relation(fields: [returnId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id])

  @@map("return_items")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model NotificationPreference {
  id            String  @id @default(uuid())
  userId        String  @unique @map("user_id")
  emailEnabled  Boolean @default(true) @map("email_enabled")
  pushEnabled   Boolean @default(true) @map("push_enabled")
  smsEnabled    Boolean @default(false) @map("sms_enabled")
  notificationTypes Json? @map("notification_types")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================================================
// LOYALTY & MEMBERSHIP
// ============================================================================

model LoyaltyPoints {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  pointsBalance  Int      @default(0) @map("points_balance")
  lifetimePoints Int      @default(0) @map("lifetime_points")
  tier           String   @default("bronze")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

model LoyaltyTransaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  points      Int
  type        String
  description String
  orderId     String?  @map("order_id")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("loyalty_transactions")
}

// ============================================================================
// SUPPORT
// ============================================================================

model SupportTicket {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  subject   String
  status    TicketStatus  @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages SupportMessage[]

  @@map("support_tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SupportMessage {
  id       String   @id @default(uuid())
  ticketId String   @map("ticket_id")
  userId   String   @map("user_id")
  message  String
  isStaff  Boolean  @default(false) @map("is_staff")
  createdAt DateTime @default(now()) @map("created_at")

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@map("support_messages")
}
